
name: CI-ASP

# ----------------------------------------------------------------------------------------------------------
# CI Pipeline for building ASP app and deplyoing it to Azure App Service
# - get config file via Rattus https://github.com/Saritasa/rattus
# - deploy to Azure App Service
# 
# Original Author: Rostislav Udaltsov
# Created: 05/11/2023
# ----------------------------------------------------------------------------------------------------------

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      build_path:
        required: true
        type: string
      template_path:
        required: true
        type: string
      build_folder:
        required: true
        type: string
      path_to_solve_file:
        required: true
        type: string
      csproj_file:
        required: true
        type: string
      app_name:
        required: true
        type: string
      azure_vault:
        required: true
        type: string
      runner_image:
        required: true
        type: string
      deployment_slot:
        required: true
        type: string
    secrets:
      azure_client_id:
        required: true
      azure_client_secret:
        required: true
      azure_tenant_id:
        required: true
      publish-profile:
        required: true
        
jobs:
  
  # Installing dependencies and building the application
  build:
    runs-on: ${{ inputs.runner_image }}
    
    # Permissions for fetch an OIDC token for a workflow
    # More information for connect your workflows to authenticate with Azure.
    # https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/configuring-openid-connect-in-azure

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout source
        uses: actions/checkout@v3

      - name: Add msbuild to PATH
        uses: microsoft/setup-msbuild@v1.3
      
      - name: Setup NuGet
        uses: NuGet/setup-nuget@v1.2
      
      - name: Restore NuGet packages
        run: cd ${{ inputs.build_path }} && nuget restore ${{ inputs.path_to_solve_file }}
      
      - name: Download Rattus
        uses: robinraju/release-downloader@v1.2
        with:
          repository: "saritasa/rattus"
          tag: "0.2"
          fileName: "rattus-windows-amd64.exe"
      
      - name: Render config file
        run: .\rattus-windows-amd64.exe > ${{ inputs.build_path }}/Web.Debug.config
        env:
          AZURE_CLIENT_ID: ${{ secrets.azure_client_id }}
          AZURE_CLIENT_SECRET: ${{ secrets.azure_client_secret }}
          AZURE_TENANT_ID: ${{ secrets.azure_tenant_id }}
          AZURE_VAULT: ${{ inputs.azure_vault }}
          TEMPLATE_PATH: ${{ inputs.template_path }}
     
      - name: Build app for release
        run: |
            msbuild ${{ inputs.build_path }}/${{ inputs.csproj_file }} /p:Configuration=Debug /p:Platform=AnyCPU /t:WebPublish /p:WebPublishMethod=FileSystem /p:DeleteExistingFiles=True /p:publishUrl=${{ inputs.build_folder }}/${{ inputs.app_name }}-${{ inputs.environment }}
      
      - name: Upload artifact for deployment job
        uses: actions/upload-artifact@v2
        with:
          name: ${{ inputs.app_name }}
          path: ${{ inputs.build_path }}/${{ inputs.build_folder }}/${{ inputs.app_name }}-${{ inputs.environment }}
      
  # Generated by Azure Depoloyment Center
  # Docs for the Azure Web Apps Deploy action: https://github.com/Azure/webapps-deploy
  # More GitHub Actions for Azure: https://github.com/Azure/actions
  
  # Deploying an application to azure cloud
  deploy:
    runs-on: ${{ inputs.runner_image }}
    needs: build
    environment:
      name: '${{ inputs.environment }}'
      url: ${{ steps.deploy-to-webapp.outputs.webapp-url }}
    
    steps:
      - name: Download artifact from build job
        uses: actions/download-artifact@v2
        with:
          name: ${{ inputs.app_name }}
      
      # slot-name should always be Production since there is only one available deployment slot
      # A publish profile is a file that contains information and settings for deploy applications and services in Azure Cloud
      # publish-profile is a file which is unique for each app serivce. It can be downloaded from app service's overview page on Azure portal:
      # https://docs.microsoft.com/en-us/azure/app-service/deploy-github-actions?tabs=applevel#generate-deployment-credentials
      
      - name: Deploy to Azure Web App
        id: deploy-to-webapp
        uses: azure/webapps-deploy@v2
        with:
          app-name: '${{ inputs.app_name }}-${{ inputs.environment }}'
          slot-name: '${{ inputs.deployment_slot }}' # deployment slot by default for new application
          publish-profile: ${{ secrets.publish-profile }}
          package: .
